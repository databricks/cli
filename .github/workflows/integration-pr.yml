name: integration-pr

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  # Trigger for pull requests.
  #
  # This workflow triggers the integration test workflow in a different repository.
  # It requires secrets from the "test-trigger-is" environment, which are only available to authorized users.
  trigger:
    runs-on:
      group: databricks-deco-testing-runner-group
      labels: ubuntu-latest-deco

    # Only run this job for PRs from branches on the main repository and not from forks.
    # Workflows triggered by PRs from forks don't have access to the "test-trigger-is" environment.
    if: "${{ !github.event.pull_request.head.repo.fork }}"

    steps:
      - name: Mark integration tests as skipped
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |-
          gh api -X POST -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -f 'state=success' \
            -f 'description=⏭️ Skipped (experimental)' \
            -f 'context=Integration Tests Check'
