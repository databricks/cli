name: release

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:

jobs:
  sign-windows:
    environment: sign
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Windows artifacts
        run: |
          gh release download v0.276.0 --pattern '*windows*.zip' --dir artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Windows binaries from archives
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path binaries -Force
          Get-ChildItem artifacts -Filter *.zip | ForEach-Object {
            $archiveName = $_.BaseName
            Expand-Archive -Path $_.FullName -DestinationPath "binaries\$archiveName"
          }

      - name: Azure Login
        uses: azure/login@e0db49e98c564cc35b6c06fc4c423ab28c39c27a # v2.4.0
        with:
          creds: '{"clientId":"${{ secrets.DECO_SIGN_AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.DECO_SIGN_AZURE_CLIENT_SECRET }}","tenantId":"${{ secrets.DECO_SIGN_AZURE_TENANT_ID }}","subscriptionId":"${{ secrets.DECO_SIGN_AZURE_SUBSCRIPTION_ID }}"}'

      - name: Setup Azure Trusted Signing
        uses: azure/trusted-signing-action@v0.5.0
        with:
          azure-tenant-id: ${{ secrets.DECO_SIGN_AZURE_TENANT_ID }}
          azure-client-id: ${{ secrets.DECO_SIGN_AZURE_CLIENT_ID }}
          azure-client-secret: ${{ secrets.DECO_SIGN_AZURE_CLIENT_SECRET }}
          endpoint: https://eus.codesigning.azure.net/
          trusted-signing-account-name: deco-sign
          certificate-profile-name: deco-sign

      - name: Sign Windows binaries
        shell: pwsh
        run: |
          Get-ChildItem binaries -Recurse -Filter *.exe | ForEach-Object {
            Write-Host "Signing $($_.FullName)"
            & signtool sign /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $_.FullName
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to sign $($_.FullName)"
            }
          }

      - name: Repackage signed binaries
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path signed-artifacts -Force
          Get-ChildItem binaries -Directory | ForEach-Object {
            $archiveName = $_.Name
            $signedArchivePath = "signed-artifacts\$archiveName-signed.zip"
            Compress-Archive -Path "$($_.FullName)\*" -DestinationPath $signedArchivePath
          }
