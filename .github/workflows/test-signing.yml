name: test-signing

on:
  workflow_dispatch:
    inputs:
      create_draft_release:
        description: 'Create a draft release with signed binaries'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-windows:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod

      - name: Build Windows binaries
        run: |
          GOOS=windows GOARCH=amd64 go build -o databricks-amd64.exe
          GOOS=windows GOARCH=arm64 go build -o databricks-arm64.exe

      - name: Create test archives
        run: |
          mkdir -p artifacts
          zip artifacts/databricks_cli_test_windows_amd64.zip databricks-amd64.exe
          zip artifacts/databricks_cli_test_windows_arm64.zip databricks-arm64.exe

      - name: Upload artifacts for signing
        uses: actions/upload-artifact@v4
        with:
          name: windows-unsigned
          path: artifacts/*.zip
          retention-days: 1

  sign-windows-test:
    runs-on: windows-latest
    needs: build-windows
    environment: sign

    steps:
      - name: Download unsigned artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-unsigned
          path: artifacts

      - name: Extract Windows binaries from archives
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path binaries -Force
          Get-ChildItem artifacts -Filter *.zip | ForEach-Object {
            $archiveName = $_.BaseName
            Expand-Archive -Path $_.FullName -DestinationPath "binaries\$archiveName"
          }

      - name: Azure Login
        uses: azure/login@e0db49e98c564cc35b6c06fc4c423ab28c39c27a # v2.4.0
        with:
          creds: '{"clientId":"${{ secrets.DECO_SIGN_AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.DECO_SIGN_AZURE_CLIENT_SECRET }}","tenantId":"${{ secrets.DECO_SIGN_AZURE_TENANT_ID }}","subscriptionId":"${{ secrets.DECO_SIGN_AZURE_SUBSCRIPTION_ID }}"}'

      - name: Setup Azure Trusted Signing
        uses: azure/trusted-signing-action@v0.5.0
        with:
          azure-tenant-id: ${{ secrets.DECO_SIGN_AZURE_TENANT_ID }}
          azure-client-id: ${{ secrets.DECO_SIGN_AZURE_CLIENT_ID }}
          azure-client-secret: ${{ secrets.DECO_SIGN_AZURE_CLIENT_SECRET }}
          endpoint: https://eus.codesigning.azure.net/
          trusted-signing-account-name: deco-sign
          certificate-profile-name: deco-sign

      - name: Sign Windows binaries
        shell: pwsh
        run: |
          Get-ChildItem binaries -Recurse -Filter *.exe | ForEach-Object {
            Write-Host "Signing $($_.FullName)"
            & signtool sign /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $_.FullName
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to sign $($_.FullName)"
            }
          }

      - name: Verify signatures
        shell: pwsh
        run: |
          Get-ChildItem binaries -Recurse -Filter *.exe | ForEach-Object {
            Write-Host "Verifying signature for $($_.FullName)"
            & signtool verify /pa /v $_.FullName
            if ($LASTEXITCODE -ne 0) {
              Write-Warning "Signature verification failed for $($_.FullName)"
            }
          }

      - name: Repackage signed binaries
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path signed-artifacts -Force
          Get-ChildItem binaries -Directory | ForEach-Object {
            $archiveName = $_.Name
            $signedArchivePath = "signed-artifacts\$archiveName-signed.zip"
            Compress-Archive -Path "$($_.FullName)\*" -DestinationPath $signedArchivePath
          }
