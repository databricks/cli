cd app

# We first run the command with different entry poiny which starts unblocking script
# so we don't need to start it in background. It will install the dependencies as part of the command
trace $CLI apps run-local --prepare-environment --entry-point test.yml

title "Starting the app in background..."
$CLI apps run-local --prepare-environment --debug > ../out.run.txt 2>&1 &
PID=$!

cd ..

echo Waiting for the app to start...
sleep 7

title "Checking app is running..."
trace curl -s -o - http://127.0.0.1:8001

title "Sending shutdown request..."
trace curl -s -o /dev/null  http://127.0.0.1:8001/shutdown || true

title "Checking CLI command output..."

trace grep "To debug your app, attach a debugger to port 5678" ./out.run.txt
trace grep -o "Python Flask app has started with: test" ./out.run.txt
rm out.run.txt
