echo "=== Creating state directory ==="
mkdir -p .databricks/bundle/default

echo "=== Creating empty WAL file ==="
touch .databricks/bundle/default/resources.json.wal

echo "=== Empty WAL file exists ==="
ls -la .databricks/bundle/default/resources.json.wal

echo "=== Deploy (should handle empty WAL gracefully) ==="
trace $CLI bundle deploy

echo "=== Checking WAL file after deploy ==="
if [ -f ".databricks/bundle/default/resources.json.wal" ]; then
    echo "WAL file exists (unexpected)"
else
    echo "Empty WAL deleted (expected)"
fi

echo "=== State file content ==="
cat .databricks/bundle/default/resources.json | jq -S '{lineage: .lineage, serial: .serial, state_keys: (.state | keys)}'
