envsubst < databricks.yml.tmpl > databricks.yml
envsubst < schema.yml.tmpl > schema.yml

cleanup() {
    trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

trace $CLI bundle deploy

title "Assert the schema is created"
trace $CLI schemas get "main.test-schema-${UNIQUE_NAME}" | jq "{full_name, comment}"

title "Assert the pipeline is created and uses the schema"
PIPELINE_ID=$($CLI bundle summary -o json | jq -r '.resources.pipelines.foo.id')
trace $CLI pipelines get "${PIPELINE_ID}" | jq "{spec}"
