envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
   trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

trace $CLI bundle validate

# URL is excluded because some cloud envs add an ?0= query param and some don't
trace $CLI bundle summary | grep -v "URL"

trace $CLI bundle deploy

# Poll for database instance to become available (max 30 attempts, 1s between attempts)
for i in {1..30}; do
  state=$($CLI database get-database-instance "test-database-instance-${UNIQUE_NAME}" --output json 2>/dev/null | jq -r '.state')
  if [ "$state" = "AVAILABLE" ]; then
    break
  fi
  if [ $i -eq 30 ]; then
    echo "Database instance did not become AVAILABLE. Last polled state: ${state}"
    exit 1
  fi
  sleep 1
done

# _dns fields are excluded since they differ between cloud envs
trace $CLI database get-database-instance "test-database-instance-${UNIQUE_NAME}" | jq 'del(.read_only_dns, .read_write_dns)'
trace $CLI bundle summary | grep -v "URL"
