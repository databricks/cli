# Create test wheel files
mkdir -p whl
echo "test wheel content" > whl/source.whl

trace $CLI bundle deploy

title "Expecting 2 wheels in libraries section in /jobs/create"
trace jq -s '.[] | select(.path=="/api/2.2/jobs/create") | .body.tasks' out.requests.txt

title "Expecting wheel to be uploaded"
trace jq .path < out.requests.txt | grep import | grep whl | sort

title "Expecting environment dependencies to be updated"
trace jq -s '.[] | select(.path=="/api/2.2/jobs/create") | .body.environments' out.requests.txt

title "Expecting delete request to artifact_path/.internal folder"
trace jq -s '.[] | select(.path=="/api/2.0/workspace/delete") | select(.body.path | test(".*/artifacts/.internal"))' out.requests.txt

title "Expecting mkdirs request to artifact_path/.internal folder"
trace jq -s '.[] | select(.path=="/api/2.0/workspace/mkdirs") | select(.body.path | test(".*/artifacts/.internal"))' out.requests.txt

rm out.requests.txt
