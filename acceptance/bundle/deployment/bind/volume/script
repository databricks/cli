VOLUME_NAME="volume-$UNIQUE_NAME"
SCHEMA_NAME="test-schema-$UNIQUE_NAME"
export VOLUME_NAME
export SCHEMA_NAME
export CATALOG_NAME="main"
envsubst < databricks.yml.tmpl > databricks.yml

VOLUME_TYPE="MANAGED"

trace $CLI schemas create "${SCHEMA_NAME}" ${CATALOG_NAME} | jq '{full_name, catalog_name}'

title "Create a pre-defined volume:"
VOLUME_FULL_NAME=$($CLI volumes create "${CATALOG_NAME}" "${SCHEMA_NAME}" "${VOLUME_NAME}" "${VOLUME_TYPE}" | jq -r '.full_name')

cleanupRemoveVolume() {
    $CLI volumes delete "${VOLUME_FULL_NAME}"
}
trap cleanupRemoveVolume EXIT

trace $CLI bundle deployment bind volume1 "${VOLUME_FULL_NAME}" --auto-approve

trace $CLI bundle deploy

trace $CLI volumes read "${VOLUME_FULL_NAME}" | jq '{catalog_name, full_name, schema_name, volume_type}'

trace $CLI bundle deployment unbind volume1

trace $CLI bundle destroy --auto-approve

trace $CLI volumes read "${VOLUME_FULL_NAME}" | jq '{catalog_name, full_name, schema_name, volume_type}'
