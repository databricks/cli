# double slash at the start prevents Windows to apply replacements to the path
EXPERIMENT_NAME="//Workspace/Users/${CURRENT_USER_NAME}/test-experiment$UNIQUE_NAME"
export EXPERIMENT_NAME
envsubst < databricks.yml.tmpl > databricks.yml

EXPERIMENT_ID=$($CLI experiments create-experiment "${EXPERIMENT_NAME}" | jq -r '.experiment_id')

cleanupRemoveExperiment() {
    title "Test cleanup:"
    title "Delete the pre-defined experiment: "
    $CLI experiments delete-experiment ${EXPERIMENT_ID}
    echo $?
}
trap cleanupRemoveExperiment EXIT

trace $CLI bundle deployment bind experiment1 ${EXPERIMENT_ID} --auto-approve

trace $CLI bundle deploy --force-lock --auto-approve

trace $CLI experiments get-experiment ${EXPERIMENT_ID} | jq '{name: .experiment.name, lifecycle_stage: .experiment.lifecycle_stage}' > out.get.$DATABRICKS_BUNDLE_ENGINE.json

trace $CLI bundle deployment unbind experiment1

trace $CLI bundle destroy --auto-approve

trace $CLI experiments get-experiment ${EXPERIMENT_ID} | jq '{name: .experiment.name, lifecycle_stage: .experiment.lifecycle_stage}' > out.get2.$DATABRICKS_BUNDLE_ENGINE.json
diff out.get.$DATABRICKS_BUNDLE_ENGINE.json out.get2.$DATABRICKS_BUNDLE_ENGINE.json
rm out.get2.$DATABRICKS_BUNDLE_ENGINE.json
