
echo "*" > .gitignore
trace $CLI bundle plan
$CLI bundle plan -o json > out.plan_create.$DATABRICKS_BUNDLE_ENGINE.json
trace $CLI bundle deploy
trace print_requests.py //jobs //pipelines > out.create.requests.json

foo_id=`read_id.py foo`

bar_id=`read_id.py bar`

trace $CLI bundle plan  # empty

title "Update storage, triggering recreate for pipeline; this means updating downstream deps"
trace update_file.py databricks.yml "storage: dbfs:/my-storage" "storage: dbfs:/my-new-storage"
trace $CLI bundle plan
$CLI bundle plan -o json > out.plan_update.$DATABRICKS_BUNDLE_ENGINE.json
trace $CLI bundle deploy --auto-approve
trace print_requests.py //jobs //pipelines > out.update.requests.$DATABRICKS_BUNDLE_ENGINE.json

foo_id_2=`read_id.py foo`

title "Fetch resource IDs and verify remote state"

trace musterr $CLI pipelines get $foo_id
trace $CLI pipelines get $foo_id_2
trace $CLI jobs get $bar_id | jq 'del(.settings.run_as)'
rm out.requests.txt

title "Follow up plan & deploy do nothing"
trace $CLI bundle plan
$CLI bundle plan -o json > out.plan_noop.$DATABRICKS_BUNDLE_ENGINE.json
trace $CLI bundle deploy
trace print_requests.py //jobs //pipelines

trace $CLI bundle destroy --auto-approve
trace print_requests.py //jobs //pipelines

trace musterr $CLI pipelines get $foo_id
trace musterr $CLI pipelines get $foo_id_2
trace musterr $CLI jobs get $bar_id
rm out.requests.txt
