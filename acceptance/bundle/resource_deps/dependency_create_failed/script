print_requests() {
    jq --sort-keys 'select(.method != "GET" and (.path | contains("/jobs")))' < out.requests.txt
    rm out.requests.txt
}

print_sorted_requests() {
    jq -c < out.requests.txt | sort | jq --sort-keys 'select(.method != "GET" and (.path | contains("/jobs")))'
    rm out.requests.txt
}

echo "*" > .gitignore
# In direct, plan is sorted by deployment order. In TF it comes back sorted alphabetically.
# I think deployment order is better, sorting here to remove the mismatch
trace $CLI bundle plan 2>&1 | sort
musterr $CLI bundle deploy &> out.deploy.$DATABRICKS_CLI_DEPLOYMENT.txt
trace print_sorted_requests

trace $CLI bundle summary

ind_id=`read_id.py jobs independent`
echo "$ind_id:IND_ID" >> ACC_REPLS

title "Plan should still contain foo and bar"
trace $CLI bundle plan  2>&1 | sort

rm out.requests.txt
musterr $CLI bundle deploy &> out.deploy2.$DATABRICKS_CLI_DEPLOYMENT.txt
title "Expecting no difference in the output between first and second deploy"
trace diff.py out.deploy.$DATABRICKS_CLI_DEPLOYMENT.txt out.deploy2.$DATABRICKS_CLI_DEPLOYMENT.txt
rm out.deploy2.$DATABRICKS_CLI_DEPLOYMENT.txt
trace print_requests

trace $CLI bundle destroy --auto-approve
trace print_requests
