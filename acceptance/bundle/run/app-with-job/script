envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
    trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

trace $CLI bundle validate
trace $CLI bundle deploy --force-lock --auto-approve

title "App should exist after bundle deployment"
trace $CLI apps get "app-${UNIQUE_NAME}" | jq '{app_status}'

title "Check app config"
trace $CLI workspace export "/Workspace/Users/${CURRENT_USER_NAME}/.bundle/app-with-job-${UNIQUE_NAME}/files/app/app.yml"

title "Try to run the app\n"
$CLI bundle run test_app &> out.app-run # sending to dev/null due to variable number of "App is starting" messages in the output
trace cat out.app-run
trace cat out.app-run | uniq

title "App should be in the running state"
trace $CLI apps get "app-${UNIQUE_NAME}" | jq '{app_status}'

title "Stop the app"
trace $CLI apps stop "app-${UNIQUE_NAME}" | jq '{compute_status}'
trace $CLI apps get "app-${UNIQUE_NAME}" | jq '{app_status,compute_status}'

title "Try to run the app again\n"
$CLI bundle run test_app &> /dev/null # sending to dev/null due to variable number of "App is starting" messages in the output

title "App should be in the running state"
trace $CLI apps get "app-${UNIQUE_NAME}" | jq '{app_status}'

title "Redeploy it again just to check that it can be redeployed"
trace $CLI bundle deploy --force-lock --auto-approve
