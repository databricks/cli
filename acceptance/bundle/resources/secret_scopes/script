SECRET_SCOPE_NAME="my-secrets-$(uuid)"
if [ -z "$CLOUD_ENV" ]; then
    SECRET_SCOPE_NAME="my-secrets-6260d50f-e8ff-4905-8f28-812345678903"   # use hard-coded uuid when running locally
fi
export SECRET_SCOPE_NAME

envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
    trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

title "create secret scope and test secret operations"
trace $CLI bundle plan
trace $CLI bundle deploy

scope_id=$($CLI bundle summary --output json | jq -r '.resources.secret_scopes.secret_scope1.id')
trace $CLI secrets list-scopes -o json | jq ".[] | select(.name == \"$scope_id\")"

title "put and get secrets"
trace $CLI secrets put-secret ${SECRET_SCOPE_NAME} my-key --string-value "my-secret-value"
trace $CLI secrets get-secret ${SECRET_SCOPE_NAME} my-key
