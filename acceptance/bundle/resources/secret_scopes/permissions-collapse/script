export SECRET_SCOPE_NAME="test-scope-collapse-$UNIQUE_NAME"

envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
    trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

title "create secret scope with duplicate permissions"
trace $CLI bundle plan -o json > out.plan.$DATABRICKS_BUNDLE_ENGINE.json
trace $CLI bundle deploy

scope_name=$($CLI bundle summary --output json | jq -r '.resources.secret_scopes.my_scope.name')
trace $CLI secrets list-scopes -o json | jq ".[] | select(.name == \"$scope_name\")"

title "verify permissions are collapsed correctly"
trace $CLI secrets list-acls $scope_name | jq -c '.[]' | sort
