#!/bin/bash
cleanup() {
    trace $CLI bundle destroy --auto-approve
}

trap cleanup EXIT

title "create the secret scope with ACLs"
trace cat databricks.yml
trace $CLI bundle plan
trace $CLI bundle deploy
scope_id=$($CLI bundle summary --output json | jq -r '.resources.secret_scopes.my_scope.id')
echo "Created scope: $scope_id"

title "verify scope exists with ACLs"
trace $CLI secrets list-scopes -o json | jq ".[] | select(.name == \"$scope_id\")"
trace $CLI secrets list-acls --scope "$scope_id" -o json | jq -c '.[]' | sort

title "no changes on rerun"
trace $CLI bundle plan
trace $CLI bundle deploy
