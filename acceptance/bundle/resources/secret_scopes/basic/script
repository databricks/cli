if [ -z "$CLOUD_ENV" ]; then
    export TEST_GROUP_NAME="test-group-$(uuid)"
    export TEST_USER_EMAIL="test-user-$(uuid)@example.com"
fi

export SECRET_SCOPE_NAME="test-scope-$UNIQUE_NAME-1"

envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
    trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

trace $CLI bundle plan
trace $CLI bundle deploy
print_requests.py --sort //secrets

scope_name=$($CLI bundle summary --output json | jq -r '.resources.secret_scopes.my_scope.name')
trace $CLI secrets list-scopes -o json | jq ".[] | select(.name == \"$scope_name\")"

# Update the name of the scope
export SECRET_SCOPE_NAME="test-scope-$UNIQUE_NAME-2"
envsubst < databricks.yml.tmpl > databricks.yml

trace $CLI bundle plan
trace $CLI bundle deploy
print_requests.py --sort //secrets

scope_name=$($CLI bundle summary --output json | jq -r '.resources.secret_scopes.my_scope.name')
trace $CLI secrets list-scopes -o json | jq ".[] | select(.name == \"$scope_name\")"
