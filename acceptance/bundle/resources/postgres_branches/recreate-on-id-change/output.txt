
>>> cat databricks.yml
bundle:
  name: deploy-postgres-branch-recreate-[UNIQUE_NAME]

sync:
  exclude:
    - "*"

resources:
  postgres_projects:
    my_project:
      project_id: test-pg-proj-[UNIQUE_NAME]
      spec:
        display_name: "Test Project"
        pg_version: 16
        history_retention_duration: "7d"
        default_endpoint_settings:
          autoscaling_limit_min_cu: 0.5
          autoscaling_limit_max_cu: 4
          suspend_timeout_duration: "5m"

  postgres_branches:
    main:
      parent: ${resources.postgres_projects.my_project.name}
      branch_id: old-branch-[UNIQUE_NAME]
      spec:
        no_expiry: true

>>> [CLI] bundle plan
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

create postgres_branches.main
create postgres_projects.my_project

Plan: 2 to add, 0 to change, 0 to delete, 0 unchanged

>>> [CLI] bundle deploy
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-branch-recreate-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests
{
  "body": {
    "spec": {
      "default_endpoint_settings": {
        "autoscaling_limit_max_cu": 4,
        "autoscaling_limit_min_cu": 0.5
      },
      "display_name": "Test Project",
      "pg_version": 16
    }
  },
  "method": "POST",
  "path": "/api/2.0/postgres/projects",
  "q": {
    "project_id": "test-pg-proj-[UNIQUE_NAME]"
  }
}
{
  "body": {
    "parent": "projects/test-pg-proj-[UNIQUE_NAME]",
    "spec": {
      "no_expiry": true
    }
  },
  "method": "POST",
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]/branches",
  "q": {
    "branch_id": "old-branch-[UNIQUE_NAME]"
  }
}

>>> cat databricks.yml
bundle:
  name: deploy-postgres-branch-recreate-[UNIQUE_NAME]

sync:
  exclude:
    - "*"

resources:
  postgres_projects:
    my_project:
      project_id: test-pg-proj-[UNIQUE_NAME]
      spec:
        display_name: "Test Project"
        pg_version: 16
        history_retention_duration: "7d"
        default_endpoint_settings:
          autoscaling_limit_min_cu: 0.5
          autoscaling_limit_max_cu: 4
          suspend_timeout_duration: "5m"

  postgres_branches:
    main:
      parent: ${resources.postgres_projects.my_project.name}
      branch_id: new-branch-[UNIQUE_NAME]
      spec:
        no_expiry: true

>>> [CLI] bundle plan
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

recreate postgres_branches.main
recreate postgres_projects.my_project

Plan: 2 to add, 0 to change, 2 to delete, 0 unchanged

>>> [CLI] bundle deploy --auto-approve
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-branch-recreate-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests
{
  "method": "DELETE",
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]"
}
{
  "body": {
    "spec": {
      "default_endpoint_settings": {
        "autoscaling_limit_max_cu": 4,
        "autoscaling_limit_min_cu": 0.5
      },
      "display_name": "Test Project",
      "pg_version": 16
    }
  },
  "method": "POST",
  "path": "/api/2.0/postgres/projects",
  "q": {
    "project_id": "test-pg-proj-[UNIQUE_NAME]"
  }
}
{
  "method": "DELETE",
  "path": "/api/2.0/postgres/[MAIN_ID]"
}
{
  "body": {
    "parent": "projects/test-pg-proj-[UNIQUE_NAME]",
    "spec": {
      "no_expiry": true
    }
  },
  "method": "POST",
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]/branches",
  "q": {
    "branch_id": "new-branch-[UNIQUE_NAME]"
  }
}

=== Fetch new branch ID and verify remote state
>>> [CLI] postgres get-branch [MAIN_ID_2]
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

{
  "name": "[MAIN_ID_2]",
  "parent": "projects/test-pg-proj-[UNIQUE_NAME]",
  "status": {
    "current_state": "READY",
    "default": false,
    "is_protected": false,
    "logical_size_bytes": 0,
    "source_branch": "projects/test-pg-proj-[UNIQUE_NAME]/branches/[BRANCH_UID]",
    "source_branch_lsn": "[LSN]",
    "source_branch_time": "[TIMESTAMP]",
    "state_change_time": "[TIMESTAMP]"
  },
  "uid": "[BRANCH_UID]"
}

=== Verify that original branch is gone
>>> musterr [CLI] postgres get-branch [MAIN_ID]
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

Error: branch id not found [TraceId: [TRACE_ID]]

=== Destroy the branch and verify that it's removed from the state and from remote
>>> [CLI] bundle destroy --auto-approve
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

The following resources will be deleted:
  delete resources.postgres_branches.main
  delete resources.postgres_projects.my_project

All files and directories at the following location will be deleted: /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-branch-recreate-[UNIQUE_NAME]/default

Deleting files...
Destroy complete!

>>> print_requests
{
  "method": "DELETE",
  "path": "/api/2.0/postgres/[MAIN_ID_2]"
}
{
  "method": "DELETE",
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]"
}

>>> musterr [CLI] postgres get-branch [MAIN_ID_2]
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

Error: project id not found [TraceId: [TRACE_ID]]

>>> [CLI] bundle destroy --auto-approve
Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.history_retention_duration
  in databricks.yml:15:37

Warning: expected map, found string
  at resources.postgres_projects.my_project.spec.default_endpoint_settings.suspend_timeout_duration
  in databricks.yml:19:37

No active deployment found to destroy!
