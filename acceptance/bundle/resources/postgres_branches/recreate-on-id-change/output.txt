
>>> cat databricks.yml
bundle:
  name: deploy-postgres-branch-recreate-[UNIQUE_NAME]

sync:
  paths: []

resources:
  postgres_projects:
    my_project:
      project_id: test-pg-proj-[UNIQUE_NAME]
      display_name: "Test Project"
      pg_version: 16
      history_retention_duration: "604800s"
      default_endpoint_settings:
        autoscaling_limit_min_cu: 0.5
        autoscaling_limit_max_cu: 4
        suspend_timeout_duration: "300s"

  postgres_branches:
    main:
      parent: ${resources.postgres_projects.my_project.id}
      branch_id: old-branch-[UNIQUE_NAME]
      no_expiry: true

>>> [CLI] bundle plan
create postgres_branches.main
create postgres_projects.my_project

Plan: 2 to add, 0 to change, 0 to delete, 0 unchanged

>>> [CLI] bundle deploy
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-branch-recreate-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

=== Change branch_id (should trigger recreation in direct, update in terraform)
>>> cat databricks.yml
bundle:
  name: deploy-postgres-branch-recreate-[UNIQUE_NAME]

sync:
  paths: []

resources:
  postgres_projects:
    my_project:
      project_id: test-pg-proj-[UNIQUE_NAME]
      display_name: "Test Project"
      pg_version: 16
      history_retention_duration: "604800s"
      default_endpoint_settings:
        autoscaling_limit_min_cu: 0.5
        autoscaling_limit_max_cu: 4
        suspend_timeout_duration: "300s"

  postgres_branches:
    main:
      parent: ${resources.postgres_projects.my_project.id}
      branch_id: new-branch-[UNIQUE_NAME]
      no_expiry: true

>>> [CLI] bundle deploy --auto-approve
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-branch-recreate-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

=== Fetch new branch ID
=== Destroy and verify cleanup
>>> [CLI] bundle destroy --auto-approve
The following resources will be deleted:
  delete resources.postgres_branches.main
  delete resources.postgres_projects.my_project

All files and directories at the following location will be deleted: /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-branch-recreate-[UNIQUE_NAME]/default

Deleting files...
Destroy complete!

>>> [CLI] bundle destroy --auto-approve
No active deployment found to destroy!
