
>>> cat databricks.yml
bundle:
  name: deploy-postgres-endpoint-recreate-[UNIQUE_NAME]

sync:
  paths: []

resources:
  postgres_projects:
    my_project:
      project_id: test-pg-proj-[UNIQUE_NAME]
      display_name: "Test Project"
      pg_version: 16
      history_retention_duration: "604800s"
      default_endpoint_settings:
        autoscaling_limit_min_cu: 0.5
        autoscaling_limit_max_cu: 4
        suspend_timeout_duration: "300s"

  postgres_branches:
    main:
      parent: ${resources.postgres_projects.my_project.id}
      branch_id: main
      no_expiry: true

  postgres_endpoints:
    my_endpoint:
      parent: ${resources.postgres_branches.main.id}
      endpoint_id: test-endpoint-[UNIQUE_NAME]
      endpoint_type: ENDPOINT_TYPE_READ_ONLY
      autoscaling_limit_min_cu: 0.5
      autoscaling_limit_max_cu: 2

>>> [CLI] bundle plan
create postgres_branches.main
create postgres_endpoints.my_endpoint
create postgres_projects.my_project

Plan: 3 to add, 0 to change, 0 to delete, 0 unchanged

>>> [CLI] bundle deploy
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-endpoint-recreate-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests
{
  "body": {
    "spec": {
      "default_endpoint_settings": {
        "autoscaling_limit_max_cu": 4,
        "autoscaling_limit_min_cu": 0.5,
        "suspend_timeout_duration": "300s"
      },
      "display_name": "Test Project",
      "history_retention_duration": "604800s",
      "pg_version": 16
    }
  },
  "method": "POST",
  "path": "/api/2.0/postgres/projects",
  "q": {
    "project_id": "test-pg-proj-[UNIQUE_NAME]"
  }
}
      "no_expiry": true
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]/branches",
    "branch_id": "main"
      "autoscaling_limit_max_cu": 2,
      "autoscaling_limit_min_cu": 0.5,
      "endpoint_type": "ENDPOINT_TYPE_READ_ONLY"
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]/branches/main/endpoints",
    "endpoint_id": "test-endpoint-[UNIQUE_NAME]"

>>> cat databricks.yml
bundle:
  name: deploy-postgres-endpoint-recreate-[UNIQUE_NAME]

sync:
  paths: []

resources:
  postgres_projects:
    my_project:
      project_id: test-pg-proj-[UNIQUE_NAME]
      display_name: "Test Project"
      pg_version: 16
      history_retention_duration: "604800s"
      default_endpoint_settings:
        autoscaling_limit_min_cu: 0.5
        autoscaling_limit_max_cu: 4
        suspend_timeout_duration: "300s"

  postgres_branches:
    main:
      parent: ${resources.postgres_projects.my_project.id}
      branch_id: main
      no_expiry: true

  postgres_endpoints:
    my_endpoint:
      parent: ${resources.postgres_branches.main.id}
      endpoint_id: test-endpoint-[UNIQUE_NAME]-v2
      endpoint_type: ENDPOINT_TYPE_READ_ONLY
      autoscaling_limit_min_cu: 0.5
      autoscaling_limit_max_cu: 2

>>> [CLI] bundle plan
recreate postgres_endpoints.my_endpoint

Plan: 1 to add, 0 to change, 1 to delete, 2 unchanged

>>> [CLI] bundle deploy --auto-approve
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-endpoint-recreate-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests
{
  "method": "DELETE",
  "path": "/api/2.0/postgres/[MY_ENDPOINT_ID]"
}
  "body": {
    "spec": {
      "autoscaling_limit_max_cu": 2,
      "autoscaling_limit_min_cu": 0.5,
      "endpoint_type": "ENDPOINT_TYPE_READ_ONLY"
    }
  },
  "method": "POST",
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]/branches/main/endpoints",
  "q": {
    "endpoint_id": "test-endpoint-[UNIQUE_NAME]-v2"
  }

=== Fetch endpoint and verify it exists after recreation
>>> [CLI] postgres get-endpoint [MY_ENDPOINT_ID]-v2
"ENDPOINT_TYPE_READ_ONLY"

=== Destroy and verify cleanup
>>> [CLI] bundle destroy --auto-approve
The following resources will be deleted:
  delete resources.postgres_branches.main
  delete resources.postgres_endpoints.my_endpoint
  delete resources.postgres_projects.my_project

All files and directories at the following location will be deleted: /Workspace/Users/[USERNAME]/.bundle/deploy-postgres-endpoint-recreate-[UNIQUE_NAME]/default

Deleting files...
Destroy complete!

>>> print_requests
{
  "method": "DELETE",
  "path": "/api/2.0/postgres/[MY_ENDPOINT_ID]-v2"
}
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]/branches/main"
  "path": "/api/2.0/postgres/projects/test-pg-proj-[UNIQUE_NAME]"

>>> [CLI] bundle destroy --auto-approve
No active deployment found to destroy!
