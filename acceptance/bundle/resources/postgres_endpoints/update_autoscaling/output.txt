
=== Initial deployment
>>> [CLI] bundle validate
Name: update-postgres-endpoint-[UNIQUE_NAME]
Target: default
Workspace:
  User: [USERNAME]
  Path: /Workspace/Users/[USERNAME]/.bundle/update-postgres-endpoint-[UNIQUE_NAME]/default

Validation OK!

>>> [CLI] bundle plan
create postgres_branches.main
create postgres_endpoints.my_endpoint
create postgres_projects.my_project

Plan: 3 to add, 0 to change, 0 to delete, 0 unchanged

>>> [CLI] bundle plan -o json

>>> [CLI] bundle deploy
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/update-postgres-endpoint-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests.py --keep --get //postgres ^//workspace-files/ ^//workspace/ ^//telemetry-ext ^//operations/

>>> [CLI] postgres get-endpoint [MY_ENDPOINT_ID]
{
  "name": "[MY_ENDPOINT_ID]",
  "parent": "projects/test-pg-proj-[UNIQUE_NAME]/branches/main",
  "status": {
    "autoscaling_limit_max_cu": 8,
    "autoscaling_limit_min_cu": 0.5,
    "current_state": "ACTIVE",
    "disabled": false,
    "endpoint_type": "ENDPOINT_TYPE_READ_ONLY",
    "hosts": {
      "host": "[ENDPOINT_UID].database.us-east-1.cloud.databricks.com"
    },
    "settings": {},
    "suspend_timeout_duration": "300s"
  },
  "uid": "[ENDPOINT_UID]"
}

=== Verify no changes
>>> [CLI] bundle plan
Plan: 0 to add, 0 to change, 0 to delete, 3 unchanged

>>> [CLI] bundle plan -o json

>>> [CLI] bundle deploy
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/update-postgres-endpoint-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests.py --keep --get //postgres ^//workspace-files/ ^//workspace/ ^//telemetry-ext ^//operations/

=== Update endpoint autoscaling and re-deploy
>>> update_file.py databricks.yml autoscaling_limit_max_cu: 8 autoscaling_limit_max_cu: 4

>>> cat databricks.yml
bundle:
  name: update-postgres-endpoint-[UNIQUE_NAME]

sync:
  paths: []

resources:
  postgres_projects:
    my_project:
      project_id: test-pg-proj-[UNIQUE_NAME]
      display_name: "Test Project for Endpoint Update"
      pg_version: 16
      history_retention_duration: 604800s

  postgres_branches:
    main:
      parent: ${resources.postgres_projects.my_project.id}
      branch_id: main
      no_expiry: true

  postgres_endpoints:
    my_endpoint:
      parent: ${resources.postgres_branches.main.id}
      endpoint_id: my-endpoint
      endpoint_type: ENDPOINT_TYPE_READ_ONLY
      autoscaling_limit_min_cu: 0.5
      autoscaling_limit_max_cu: 4
      suspend_timeout_duration: 300s

>>> [CLI] bundle plan
update postgres_endpoints.my_endpoint

Plan: 0 to add, 1 to change, 0 to delete, 2 unchanged

>>> [CLI] bundle plan -o json

>>> [CLI] bundle deploy
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/update-postgres-endpoint-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests.py --keep --get //postgres ^//workspace-files/ ^//workspace/ ^//telemetry-ext ^//operations/

>>> [CLI] postgres get-endpoint [MY_ENDPOINT_ID]
{
  "name": "[MY_ENDPOINT_ID]",
  "parent": "projects/test-pg-proj-[UNIQUE_NAME]/branches/main",
  "status": {
    "autoscaling_limit_max_cu": 4,
    "autoscaling_limit_min_cu": 0.5,
    "current_state": "ACTIVE",
    "disabled": false,
    "endpoint_type": "ENDPOINT_TYPE_READ_ONLY",
    "hosts": {
      "host": "[ENDPOINT_UID].database.us-east-1.cloud.databricks.com"
    },
    "settings": {},
    "suspend_timeout_duration": "300s"
  },
  "uid": "[ENDPOINT_UID]"
}

=== Restore endpoint autoscaling to original value
>>> update_file.py databricks.yml autoscaling_limit_max_cu: 4 autoscaling_limit_max_cu: 8

>>> [CLI] bundle plan
update postgres_endpoints.my_endpoint

Plan: 0 to add, 1 to change, 0 to delete, 2 unchanged

>>> [CLI] bundle plan -o json

>>> [CLI] bundle deploy
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/update-postgres-endpoint-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests.py --keep --get //postgres ^//workspace-files/ ^//workspace/ ^//telemetry-ext ^//operations/

>>> [CLI] postgres get-endpoint [MY_ENDPOINT_ID]
{
  "name": "[MY_ENDPOINT_ID]",
  "parent": "projects/test-pg-proj-[UNIQUE_NAME]/branches/main",
  "status": {
    "autoscaling_limit_max_cu": 8,
    "autoscaling_limit_min_cu": 0.5,
    "current_state": "ACTIVE",
    "disabled": false,
    "endpoint_type": "ENDPOINT_TYPE_READ_ONLY",
    "hosts": {
      "host": "[ENDPOINT_UID].database.us-east-1.cloud.databricks.com"
    },
    "settings": {},
    "suspend_timeout_duration": "300s"
  },
  "uid": "[ENDPOINT_UID]"
}

>>> [CLI] bundle destroy --auto-approve
The following resources will be deleted:
  delete resources.postgres_branches.main
  delete resources.postgres_endpoints.my_endpoint
  delete resources.postgres_projects.my_project

All files and directories at the following location will be deleted: /Workspace/Users/[USERNAME]/.bundle/update-postgres-endpoint-[UNIQUE_NAME]/default

Deleting files...
Destroy complete!
