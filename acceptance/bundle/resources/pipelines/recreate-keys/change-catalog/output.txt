
>>> cat databricks.yml
bundle:
  name: acc-[UNIQUE_NAME]

resources:
  pipelines:
    my:
      name: test-pipeline-[UNIQUE_NAME]
      #storage: dbfs:/pipelines/custom
      catalog: mycatalog1
      #ingestion_definition: {"connection_name": "my_connection", "objects": [{}]}
      libraries:
        - file:
            path: "./foo.py"

>>> [CLI] bundle plan
create pipelines.my

Plan: 1 to add, 0 to change, 0 to delete, 0 unchanged

>>> [CLI] bundle deploy
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests
{
  "body": {
    "catalog": "mycatalog1",
    "channel": "CURRENT",
    "deployment": {
      "kind": "BUNDLE",
      "metadata_file_path": "/Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/state/metadata.json"
    },
    "edition": "ADVANCED",
    "libraries": [
      {
        "file": {
          "path": "/Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/files/foo.py"
        }
      }
    ],
    "name": "test-pipeline-[UNIQUE_NAME]"
  },
  "method": "POST",
  "path": "/api/2.0/pipelines"
}

>>> update_file.py databricks.yml catalog1 catalog2

>>> [CLI] bundle plan
update pipelines.my

Plan: 0 to add, 1 to change, 0 to delete, 0 unchanged

>>> [CLI] bundle deploy --auto-approve
Uploading bundle files to /Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/files...
Deploying resources...
Updating deployment state...
Deployment complete!

>>> print_requests
{
  "body": {
    "catalog": "mycatalog2",
    "channel": "CURRENT",
    "deployment": {
      "kind": "BUNDLE",
      "metadata_file_path": "/Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/state/metadata.json"
    },
    "edition": "ADVANCED",
    "id": "[PIPELINE_ID_1]",
    "libraries": [
      {
        "file": {
          "path": "/Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/files/foo.py"
        }
      }
    ],
    "name": "test-pipeline-[UNIQUE_NAME]"
  },
  "method": "PUT",
  "path": "/api/2.0/pipelines/[PIPELINE_ID_1]"
}

=== Fetch pipeline ID and verify remote state
>>> [CLI] pipelines get [PIPELINE_ID_1]
{
  "creator_user_name":"[USERNAME]",
  "last_modified":[UNIX_TIME_MILLIS][0],
  "name":"test-pipeline-[UNIQUE_NAME]",
  "pipeline_id":"[PIPELINE_ID_1]",
  "run_as_user_name":"[USERNAME]",
  "spec": {
    "catalog":"mycatalog2",
    "channel":"CURRENT",
    "deployment": {
      "kind":"BUNDLE",
      "metadata_file_path":"/Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/state/metadata.json"
    },
    "edition":"ADVANCED",
    "id":"[PIPELINE_ID_1]",
    "libraries": [
      {
        "file": {
          "path":"/Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/files/foo.py"
        }
      }
    ],
    "name":"test-pipeline-[UNIQUE_NAME]"
  },
  "state":"IDLE"
}

=== Verify that original pipeline is gone
>>> musterr [CLI] pipelines get [PIPELINE_ID_1]
{
  "creator_user_name":"[USERNAME]",
  "last_modified":[UNIX_TIME_MILLIS][0],
  "name":"test-pipeline-[UNIQUE_NAME]",
  "pipeline_id":"[PIPELINE_ID_1]",
  "run_as_user_name":"[USERNAME]",
  "spec": {
    "catalog":"mycatalog2",
    "channel":"CURRENT",
    "deployment": {
      "kind":"BUNDLE",
      "metadata_file_path":"/Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/state/metadata.json"
    },
    "edition":"ADVANCED",
    "id":"[PIPELINE_ID_1]",
    "libraries": [
      {
        "file": {
          "path":"/Workspace/Users/[USERNAME]/.bundle/acc-[UNIQUE_NAME]/default/files/foo.py"
        }
      }
    ],
    "name":"test-pipeline-[UNIQUE_NAME]"
  },
  "state":"IDLE"
}

Unexpected success

Exit code: 1
