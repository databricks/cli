envsubst < databricks.yml.tmpl > databricks.yml

trace $CLI bundle deploy

alert_id=$($CLI bundle summary --output json | jq -r '.resources.alerts.myalert.id')

echo "$alert_id:ALERT_ID" >> ACC_REPLS

trace $CLI alerts-v2 get-alert $alert_id | jq '{display_name, lifecycle_state, custom_summary, evaluation, query_text, schedule, warehouse_id}'

title "assert that permissions are applied"
trace $CLI permissions get alertsv2 $alert_id | jq ".access_control_list.[]" -c | grep 'deco-test-user@databricks.com' | jq '{user_name, all_permissions}'

title "assert that no permanent drift happens"
trace $CLI bundle plan

trace $CLI bundle destroy --auto-approve

trace $CLI alerts-v2 get-alert $alert_id | jq '{display_name, lifecycle_state}'

trace $CLI bundle summary
