envsubst < databricks.yml.tmpl > databricks.yml


cleanup() {
    trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

trace $CLI bundle validate -o json | jq .resources.alerts.myalert

trace $CLI bundle deploy

alert_id=$($CLI bundle summary --output json | jq -r '.resources.alerts.myalert.id')

echo "$alert_id:ALERT_ID" >> ACC_REPLS

trace $CLI alerts-v2 get-alert $alert_id | jq '{display_name, lifecycle_state, custom_summary, evaluation, query_text, schedule, warehouse_id}'

alert_path=$($CLI bundle summary --output json | jq -r '.resources.alerts.myalert.parent_path')/myalert.dbalert.json
title "assert that the uploaded alert file is the same as the local one"
trace $CLI workspace export $alert_path > exported_alert.dbalert.json
trace diff exported_alert.dbalert.json alert.dbalert.json --strip-trailing-cr
rm exported_alert.dbalert.json

trace $CLI alerts-v2 get-alert $alert_id | jq '{display_name, lifecycle_state}'

trace $CLI bundle summary
