envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
   trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

print_requests() {
    local name=$1
    trace print_requests.py --keep --get '//postgres' '^//workspace-files/' '^//workspace/' '^//telemetry-ext' '^//operations/' > out.requests.${name}.$DATABRICKS_BUNDLE_ENGINE.json
    rm -f out.requests.txt
}

title "Initial deployment"
trace $CLI bundle validate
trace $CLI bundle plan -o json | jq '.plan."resources.postgres_projects.my_project" // .' > out.plan.create.$DATABRICKS_BUNDLE_ENGINE.json
rm -f out.requests.txt
trace $CLI bundle deploy

print_requests create

project_name="projects/test-pg-proj-${UNIQUE_NAME}"
project_id_1=`read_id.py my_project`
trace $CLI postgres get-project "${project_name}" | jq 'del(.create_time, .update_time)'

title "Verify no changes"
trace $CLI bundle plan -o json | jq '.plan."resources.postgres_projects.my_project" // .' > out.plan.no_change.$DATABRICKS_BUNDLE_ENGINE.json
rm -f out.requests.txt
trace $CLI bundle deploy

print_requests no_change

title "Update display_name and re-deploy"
trace update_file.py databricks.yml "Original Name" "Updated Name"
trace cat databricks.yml

trace $CLI bundle plan -o json | jq '.plan."resources.postgres_projects.my_project" // .' > out.plan.update.$DATABRICKS_BUNDLE_ENGINE.json
rm -f out.requests.txt
trace $CLI bundle deploy

print_requests update

project_id_2=`read_id.py my_project`
trace $CLI postgres get-project "${project_name}" | jq 'del(.create_time, .update_time)'

title "Restore display_name to original value"
trace update_file.py databricks.yml "Updated Name" "Original Name"
trace $CLI bundle plan -o json | jq '.plan."resources.postgres_projects.my_project" // .' > out.plan.restore.$DATABRICKS_BUNDLE_ENGINE.json
rm -f out.requests.txt
trace $CLI bundle deploy

print_requests restore

trace $CLI postgres get-project "${project_name}" | jq 'del(.create_time, .update_time)'
