#!/bin/bash
envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
   trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

print_requests() {
    trace print_requests.py --keep --get '//postgres' '^//workspace-files/' '^//workspace/' '^//telemetry-ext' '^//operations/' > out.requests.json
    rm -f out.requests.txt
}

title "Initial deployment"
trace $CLI bundle validate
trace $CLI bundle plan
rm -f out.requests.txt
trace $CLI bundle deploy

print_requests
mv out.requests.json out.create.requests.json

project_name="projects/test-pg-proj-${UNIQUE_NAME}"
project_id_1=`read_id.py my_project`
trace $CLI postgres get-project "${project_name}" | jq 'del(.create_time, .update_time)'

title "Verify idempotency (no changes)"
trace $CLI bundle plan
rm -f out.requests.txt
trace $CLI bundle deploy

print_requests
mv out.requests.json out.idempotency.requests.json

title "Update display_name and re-deploy"
trace update_file.py databricks.yml "Original Name" "Updated Name"
trace cat databricks.yml

trace $CLI bundle plan
rm -f out.requests.txt
trace $CLI bundle deploy

print_requests
mv out.requests.json out.update.requests.json

project_id_2=`read_id.py my_project`
trace $CLI postgres get-project "${project_name}" | jq 'del(.create_time, .update_time)'

title "Restore display_name to original value"
trace update_file.py databricks.yml "Updated Name" "Original Name"
trace $CLI bundle plan
rm -f out.requests.txt
trace $CLI bundle deploy

print_requests
mv out.requests.json out.restore.requests.json

trace $CLI postgres get-project "${project_name}" | jq 'del(.create_time, .update_time)'
