set -euo pipefail

render_config() {
    local template="$1"
    local output="$2"
    envsubst < "$template" > "$output"
}

print_requests() {
    jq -s 'map(select(.path | contains("/unity-catalog/schemas") or contains("/unity-catalog/permissions"))) | sort_by(.path) | .[]' < out.requests.txt
    rm -f out.requests.txt
}

cleanup() {
    trace $CLI bundle destroy --auto-approve || true
    rm -f config_initial.yml config_update.yml config_empty.yml out.requests.txt
}
trap cleanup EXIT

render_config initial.yml.tmpl config_initial.yml
render_config update.yml.tmpl config_update.yml
render_config empty.yml.tmpl config_empty.yml

SCHEMA_FULL_NAME="main.schema_grants_${UNIQUE_NAME}"
echo "${SCHEMA_FULL_NAME}:SCHEMA_FULL_NAME" >> ACC_REPLS
echo "schema_grants_${UNIQUE_NAME}:SCHEMA_NAME" >> ACC_REPLS

cp config_initial.yml databricks.yml
trace $CLI bundle deploy --auto-approve
trace print_requests > out.requests_create.direct.json

cp config_update.yml databricks.yml
trace $CLI bundle deploy --auto-approve
trace print_requests > out.requests_update.direct.json

cp config_empty.yml databricks.yml
trace $CLI bundle deploy --auto-approve
trace print_requests > out.requests_empty.direct.json

trace $CLI bundle destroy --auto-approve
trace print_requests > out.requests_destroy.direct.json
