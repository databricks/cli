envsubst < databricks.yml.tmpl > databricks.yml

trace $CLI bundle plan
trace $CLI bundle plan -o json > out.plan1.$DATABRICKS_BUNDLE_ENGINE.json
jq 'walk(if type == "object" then del(.created_at, .created_by, .updated_at, .updated_by, .metastore_id, .browse_only, .effective_predictive_optimization_flag, .enable_predictive_optimization, .isolation_mode, .securable_type) else . end)' out.plan1.$DATABRICKS_BUNDLE_ENGINE.json > tmp.json && mv tmp.json out.plan1.$DATABRICKS_BUNDLE_ENGINE.json
trace print_requests.py --get //permissions
trace $CLI bundle deploy
trace print_requests.py //permissions > out.deploy1.requests.$DATABRICKS_BUNDLE_ENGINE.json

trace $CLI bundle plan

# Since we're sending different requests between terraform and direct, assert that the end result is the same:
trace $CLI grants get catalog catalog_grants_$UNIQUE_NAME | jq --sort-keys

update_file.py databricks.yml CREATE_SCHEMA USE_SCHEMA

trace $CLI bundle plan -o json > out.plan2.$DATABRICKS_BUNDLE_ENGINE.json
jq 'walk(if type == "object" then del(.created_at, .created_by, .updated_at, .updated_by, .metastore_id, .browse_only, .effective_predictive_optimization_flag, .enable_predictive_optimization, .isolation_mode, .securable_type) else . end)' out.plan2.$DATABRICKS_BUNDLE_ENGINE.json > tmp.json && mv tmp.json out.plan2.$DATABRICKS_BUNDLE_ENGINE.json
trace print_requests.py --get //permissions
trace $CLI bundle deploy
trace print_requests.py //permissions > out.deploy2.requests.$DATABRICKS_BUNDLE_ENGINE.json

trace $CLI grants get catalog catalog_grants_$UNIQUE_NAME | jq --sort-keys

trace $CLI bundle destroy --auto-approve
trace print_requests.py //permissions > out.destroy.requests.$DATABRICKS_BUNDLE_ENGINE.json
