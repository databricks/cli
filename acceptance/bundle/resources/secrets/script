SECRET_SCOPE_NAME="secrets-test-$(uuid)"
if [ -z "$CLOUD_ENV" ]; then
    SECRET_SCOPE_NAME="secrets-test-6260d50f-e8ff-4905-8f28-812345678903"   # use hard-coded uuid when running locally
fi
export SECRET_SCOPE_NAME

envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
    trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

title "Deploy the secret scope first"
trace $CLI bundle deploy

title "Verify the secret scope was created"
trace $CLI secrets list-scopes -o json | jq --arg name "${SECRET_SCOPE_NAME}" '.[] | select(.name == $name)'

title "Create a secret via CLI"
trace $CLI secrets put-secret ${SECRET_SCOPE_NAME} my-secret-key --string-value "my-secret-value"

title "Verify secret was created"
trace $CLI secrets get-secret ${SECRET_SCOPE_NAME} my-secret-key

title "Now add a secret to the bundle"
cat > databricks.yml <<EOF
bundle:
  name: deploy-secrets-test-${UNIQUE_NAME}

resources:
  secret_scopes:
    test_scope:
      name: ${SECRET_SCOPE_NAME}

  secrets:
    secret1:
      scope: ${SECRET_SCOPE_NAME}
      key: bundle_secret
      string_value: "bundle-secret-value"
EOF

title "Deploy bundle with secret (scope already exists)"
trace $CLI bundle deploy

title "Verify bundle secret was created"
trace $CLI secrets get-secret ${SECRET_SCOPE_NAME} bundle_secret
