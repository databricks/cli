DASHBOARD_DISPLAY_NAME="test bundle-deploy-dashboard $(uuid)"
if [ -z "$CLOUD_ENV" ]; then
    export TEST_DEFAULT_WAREHOUSE_ID="warehouse-1234"
fi
cp $TESTDIR/../simple/sample-dashboard.lvdash.json .

export DASHBOARD_DISPLAY_NAME
envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
    trace $CLI bundle destroy --auto-approve
    rm sample-dashboard.lvdash.json
}
trap cleanup EXIT

trace $CLI bundle deploy
DASHBOARD_ID=$($CLI bundle summary --output json | jq -r '.resources.dashboards.dashboard1.id')
trace $CLI lakeview get $DASHBOARD_ID | jq '{lifecycle_state, parent_path, path, serialized_dashboard: (.serialized_dashboard | fromjson | {pages: (.pages | map({name, displayName, pageType}))})}'

cat out.requests.txt | \
 jq 'select(.method == "POST" or .method == "PATCH")' | \
 jq 'select( (.path | contains("/api/2.0/lakeview/dashboards")) or ((.path == "/api/2.0/workspace/mkdirs") and (.body.path | contains("/default/resources"))))' \
 > out.requests.$DATABRICKS_BUNDLE_ENGINE.txt
