export DASHBOARD_DISPLAY_NAME="test bundle-deploy-dashboard $UNIQUE_NAME)"

if [ -z "$CLOUD_ENV" ]; then
    export TEST_DEFAULT_WAREHOUSE_ID="warehouse-1234"
    echo "warehouse-1234:TEST_DEFAULT_WAREHOUSE_ID" >> ACC_REPLS
fi

envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
    $CLI bundle destroy --auto-approve > /dev/null 2>&1
}
trap cleanup EXIT

# Deploy the dashboard
trace $CLI bundle deploy
DASHBOARD_ID=$($CLI bundle summary --output json | jq -r '.resources.dashboards.dashboard1.id')

# Capture the dashboard ID as a replacement.
echo "$DASHBOARD_ID:DASHBOARD_ID" >> ACC_REPLS

# Verify dashboard was deployed and is published
trace $CLI lakeview get-published $DASHBOARD_ID | jq '{embed_credentials}'

# Unpublish the dashboard out of band (simulating external action)
trace $CLI lakeview unpublish $DASHBOARD_ID

title "Run bundle plan after unpublishing"
# Terraform: shows "skip" because it only reads draft state, not published state
# Direct: shows "create" because GetPublished returns 404, causing DoRead to fail
$CLI bundle plan > out.plan.$DATABRICKS_BUNDLE_ENGINE.txt

$CLI bundle plan -o json > out.plan.$DATABRICKS_BUNDLE_ENGINE.json
