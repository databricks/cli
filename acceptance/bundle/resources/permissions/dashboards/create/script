if [ -z "$CLOUD_ENV" ]; then
    export TEST_USER_EMAIL="viewer@databricks.com"
    export TEST_GROUP_NAME="data-team"
    export TEST_SP_APPLICATION_ID="f37d18cd-98a8-4db5-8112-12dd0a6bfe38"

    echo "$TEST_USER_EMAIL:TEST_USER_EMAIL" >> ACC_REPLS
    echo "$TEST_GROUP_NAME:TEST_GROUP_NAME" >> ACC_REPLS
    echo "$TEST_SP_APPLICATION_ID:TEST_SP_APPLICATION_ID" >> ACC_REPLS
fi

envsubst < databricks.yml.tmpl > databricks.yml

trace $CLI bundle validate -o json | jq .resources.dashboards.foo.permissions
rm out.requests.txt

$CLI bundle debug plan > out.plan.$DATABRICKS_BUNDLE_ENGINE.json

print_requests() {
    jq -c < out.requests.txt | jq 'select(.method != "GET" and (.path | contains("permissions")))'
    rm out.requests.txt
}

rm out.requests.txt
trace $CLI bundle deploy

dashboard_id=$($CLI bundle summary --output json | jq -r '.resources.dashboards.foo.id')
echo "$dashboard_id:DASHBOARD_ID" >> ACC_REPLS

print_requests > out.requests.deploy.$DATABRICKS_BUNDLE_ENGINE.json

trace $CLI bundle destroy --auto-approve
print_requests > out.requests.destroy.$DATABRICKS_BUNDLE_ENGINE.json
