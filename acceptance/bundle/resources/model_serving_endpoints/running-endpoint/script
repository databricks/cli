export VERSION=$($CLI model-versions list system.ai.llama_v3_2_1b_instruct | jq '.[0].version')

envsubst < databricks.yml.tmpl > databricks.yml

cleanup() {
    trace $CLI bundle destroy --auto-approve
    rm out.requests.txt
}
trap cleanup EXIT

trace $CLI bundle plan -o json > out.plan.$DATABRICKS_BUNDLE_ENGINE.txt
trace $CLI bundle deploy

trace print_requests.py //serving-endpoints

endpoint_name=$($CLI bundle summary -o json | jq -r '.resources.model_serving_endpoints.my_endpoint.name')
endpoint_id=$($CLI bundle summary -o json | jq -r '.resources.model_serving_endpoints.my_endpoint.id')
trace $CLI serving-endpoints get $endpoint_name | jq '{name, creator}'

title "verify there's no persistent drift"
trace $CLI bundle plan
