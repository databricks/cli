envsubst < databricks.yml.tmpl > databricks.yml
trace $CLI bundle deploy

print_requests() {
    jq --sort-keys 'select(.method != "GET" and (.path | contains("/serving-endpoints")))' < out.requests.txt
}

title "Initial deployment"
trace print_requests

endpoint_name=$(jq -r 'select(.method == "POST" and (.path | contains("/serving-endpoints"))) | .body.name' < out.requests.txt | head -1)
echo "$endpoint_name:ENDPOINT_ID" >> ACC_REPLS
rm out.requests.txt

title "Update the endpoint configuration (change model version)"
update_file.py databricks.yml "1" "2"
trace $CLI bundle deploy
trace print_requests

title "Verify the endpoint was updated (not recreated)"
trace $CLI serving-endpoints get $endpoint_name

title "Verify endpoint is in NOT_UPDATING state after update"
$CLI serving-endpoints get $endpoint_name | jq -r '.state.config_update' | grep -q 'NOT_UPDATING'
echo ""
echo "Endpoint is in NOT_UPDATING state"

title "Verify the model version was updated"
$CLI serving-endpoints get $endpoint_name | jq -r '.config.served_entities[0].entity_version' | grep -q '2'
echo ""
echo "Model version updated to 2"

title "Destroy the endpoint"
trace $CLI bundle destroy --auto-approve
trace print_requests
trace musterr $CLI serving-endpoints get $endpoint_name
rm out.requests.txt
