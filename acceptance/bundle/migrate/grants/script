trace DATABRICKS_BUNDLE_ENGINE=terraform $CLI bundle deploy
print_state.py > out.original_state.json

trace $CLI bundle deployment migrate 2>&1 | contains.py 'Migrated 6 resources'
print_state.py > out.new_state.json

# this is expected to fail because state does not match env var
trace DATABRICKS_BUNDLE_ENGINE=terraform musterr $CLI bundle plan
trace DATABRICKS_BUNDLE_ENGINE=terraform musterr $CLI bundle deploy

rm out.requests.txt
# Both DATABRICKS_BUNDLE_ENGINE=direct and DATABRICKS_BUNDLE_ENGINE= work
trace DATABRICKS_BUNDLE_ENGINE=direct $CLI bundle plan | contains.py "6 unchanged"
trace DATABRICKS_BUNDLE_ENGINE= $CLI bundle plan | contains.py "6 unchanged"
trace print_requests.py --get //unity-catalog/permissions | contains.py 'engine/direct' > /dev/null

trace DATABRICKS_BUNDLE_ENGINE="" $CLI bundle deploy
trace print_requests.py --get //unity-catalog/permissions | jq '.headers["User-Agent"][0]' | contains.py 'engine/direct' > LOG.requests_deploy.txt

title "Should show that it's already migrated"
trace musterr $CLI bundle deployment migrate
trace DATABRICKS_BUNDLE_ENGINE= $CLI bundle debug states
trace DATABRICKS_BUNDLE_ENGINE= $CLI bundle debug states --force-pull

rm out.requests.txt
