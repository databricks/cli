if [ -z "${TEST_SP_APPLICATION_ID+x}" ]; then
    export TEST_SP_APPLICATION_ID="123b0db3-ba48-4e12-be3b-3b7898cdf000"
fi

envsubst < databricks.yml.tmpl > databricks.yml
trace DATABRICKS_BUNDLE_ENGINE=terraform $CLI bundle plan -t production

cleanup() {
    trace $CLI bundle destroy --auto-approve
}


trap cleanup EXIT

trace DATABRICKS_BUNDLE_ENGINE=terraform $CLI bundle deploy -t production
trace print_requests.py //pipelines > out.create_requests.json
trace print_state.py -t production > out.old_state.json

pipeline_id=$($CLI bundle summary -t production --output json | jq -r '.resources.pipelines.foo.id')
trace $CLI pipelines get $pipeline_id > out.pipelines_get.json

trace DATABRICKS_BUNDLE_ENGINE=terraform $CLI bundle plan -t production
trace DATABRICKS_BUNDLE_ENGINE= $CLI bundle deployment migrate -t production
trace print_state.py -t production > out.new_state.json
trace DATABRICKS_BUNDLE_ENGINE= $CLI bundle plan -t production
trace DATABRICKS_BUNDLE_ENGINE= $CLI bundle plan -t production -o json > out.plan.json
