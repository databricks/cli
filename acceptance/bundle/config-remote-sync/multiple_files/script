#!/bin/bash

envsubst < databricks.yml.tmpl > databricks.yml
envsubst < resources/job1.yml.tmpl > resources/job1.yml
envsubst < resources/job2.yml.tmpl > resources/job2.yml

cleanup() {
  trace $CLI bundle destroy --auto-approve
}
trap cleanup EXIT

touch dummy.whl
$CLI bundle deploy

job_one_id="$(read_id.py job_one)"
job_two_id="$(read_id.py job_two)"

title "Modify job_one: max_concurrent_runs, rename c_task"
edit_resource.py jobs $job_one_id <<'EOF'
r["max_concurrent_runs"] = 5
for task in r["tasks"]:
    if task["task_key"] == "c_task":
        task["task_key"] = "c_task_renamed"
    if "depends_on" in task:
        for dep in task["depends_on"]:
            if dep["task_key"] == "c_task":
                dep["task_key"] = "c_task_renamed"
EOF

title "Add synced_task to job_one (notebook in sync root, resource in subdirectory)"
edit_resource.py jobs $job_one_id <<EOF
r["tasks"].append({
    "task_key": "synced_task",
    "notebook_task": {
        "notebook_path": "${PWD}/synced_notebook"
    },
    "new_cluster": {
        "spark_version": "${DEFAULT_SPARK_VERSION}",
        "node_type_id": "${NODE_TYPE_ID}",
        "num_workers": 1
    }
})
EOF

title "Modify job_two: max_concurrent_runs, rename first task, add extra_task"
edit_resource.py jobs $job_two_id <<'EOF'
r["max_concurrent_runs"] = 10
cluster = None
for task in r["tasks"]:
    if task["task_key"] == "run_pipeline":
        task["task_key"] = "run_pipeline_renamed"
        cluster = task.get("new_cluster")
r["tasks"].append({
    "task_key": "extra_task",
    "notebook_task": {"notebook_path": "/Users/{{workspace_user_name}}/extra"},
    "new_cluster": cluster,
})
EOF

title "Add extra_task to local config (not in saved state, triggers entity-level replace)"
cat >> resources/job2.yml << 'YAML'
        - task_key: extra_task
          notebook_task:
            notebook_path: /Users/{{workspace_user_name}}/extra
YAML

title "Detect and save changes"
echo
cp resources/job1.yml resources/job1.yml.backup
cp resources/job2.yml resources/job2.yml.backup
$CLI bundle config-remote-sync --save

title "Changes in job1.yml"
echo
trace diff.py resources/job1.yml.backup resources/job1.yml

title "Changes in job2.yml"
echo
trace diff.py resources/job2.yml.backup resources/job2.yml
rm resources/job1.yml.backup resources/job2.yml.backup
