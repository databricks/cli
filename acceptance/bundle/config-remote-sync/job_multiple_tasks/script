#!/bin/bash

envsubst < databricks.yml.tmpl > databricks.yml

touch dummy.whl
$CLI bundle deploy
job_id="$(read_id.py my_job)"


title "Modify only 'process' task num_workers and add timeout"
edit_resource.py jobs $job_id <<EOF
for task in r["tasks"]:
    if task["task_key"] == "task3":
        task["new_cluster"]["num_workers"] = 5
        task["timeout_seconds"] = 3600
        task["depends_on"] = [{"task_key": "task1"}]

r["tasks"] = [task for task in r["tasks"] if task["task_key"] != "task2"]

EOF

title "Detect and save changes"
echo
cp databricks.yml databricks.yml.backup
$CLI bundle config-remote-sync --save

title "Configuration changes"
echo
trace diff.py databricks.yml.backup databricks.yml
rm databricks.yml.backup
