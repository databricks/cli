#!/bin/bash
set -euo pipefail

envsubst < databricks.yml.tmpl > databricks.yml

$CLI bundle deploy

# Get the job ID
job_id="$(read_id.py sample_job)"

# Rename task remotely: notebook_task -> notebook_task_renamed
# Also update the dependency references
edit_resource.py jobs $job_id <<'EOF'
for task in r["tasks"]:
    if task["task_key"] == "notebook_task":
        task["task_key"] = "notebook_task_renamed"
    # Update dependencies that reference the old key
    if "depends_on" in task:
        for dep in task["depends_on"]:
            if dep["task_key"] == "notebook_task":
                dep["task_key"] = "notebook_task_renamed"
EOF

# Try to sync - this should fail with YAML patch error
$CLI bundle config-remote-sync --save || true
