#!/bin/bash

envsubst < databricks.yml.tmpl > databricks.yml

touch dummy.whl
$CLI bundle deploy
job_id="$(read_id.py test_job)"


title "Remove taskB (index 1) and update taskC (index 2)"
edit_resource.py jobs $job_id <<EOF
# Remove taskB
r["tasks"] = [task for task in r["tasks"] if task["task_key"] != "taskB"]

# Update taskC - originally at index 2, after removal should be at index 1
for task in r["tasks"]:
    if task["task_key"] == "taskC":
        task["timeout_seconds"] = 7200
        task["new_cluster"]["num_workers"] = 3
EOF

title "Detect and save changes"
echo
cp databricks.yml databricks.yml.backup
$CLI bundle config-remote-sync --save

title "Configuration changes"
echo
trace diff.py databricks.yml.backup databricks.yml
rm databricks.yml.backup

title "Verify changes"
echo
grep -A 10 "task_key: taskC" databricks.yml | grep "timeout_seconds: 7200" && echo "✓ taskC has timeout_seconds: 7200"
grep -A 10 "task_key: taskC" databricks.yml | grep "num_workers: 3" && echo "✓ taskC has num_workers: 3"
grep "task_key: taskB" databricks.yml && echo "✗ taskB still exists (FAIL)" && exit 1 || echo "✓ taskB was removed"
grep "task_key: taskD" databricks.yml && echo "✓ taskD still exists" || (echo "✗ taskD was removed (FAIL)" && exit 1)
