#!/bin/bash

envsubst < databricks.yml.tmpl > databricks.yml

title "Deploy bundle"
echo
$CLI bundle deploy

title "Get job ID and modify remote resource"
echo
job_id="$(read_id.py test_job)"
echo "Modify max_concurrent_runs to 5"
edit_resource.py jobs $job_id <<EOF
r["max_concurrent_runs"] = 5
EOF

title "Flush local cache"
echo
echo "Removing .databricks directory to simulate flushed cache"
rm -rf .databricks
ls -la .databricks 2>&1 || echo "Cache directory removed"

title "Check for changes after cache flush"
echo
$CLI bundle config-remote-sync
