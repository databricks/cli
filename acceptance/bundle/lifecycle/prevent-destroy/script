trace $CLI bundle validate

trace $CLI bundle deploy

trace errcode $CLI bundle plan
trace musterr $CLI bundle destroy --auto-approve >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1

# Changing the catalog name, deploy must fail because pipeline will be recreated
update_file.py resources/pipeline.yml 'catalog: main' 'catalog: mainnew'
trace errcode $CLI bundle plan >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1
trace musterr $CLI bundle deploy >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1

# Changing the schema name, deploy must fail because schema will be recreated
update_file.py resources/schema.yml 'name: test-schema' 'name: test-schema-new'
trace errcode $CLI bundle plan >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1
trace musterr $CLI bundle deploy >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1

# Removing the prevent_destroy, deploy must succeed
update_file.py resources/pipeline.yml 'prevent_destroy: true' 'prevent_destroy: false'
update_file.py resources/schema.yml 'prevent_destroy: true' 'prevent_destroy: false'
trace errcode $CLI bundle plan >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1
trace $CLI bundle deploy --auto-approve >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1
update_file.py resources/pipeline.yml 'prevent_destroy: false' 'prevent_destroy: true'
update_file.py resources/schema.yml 'prevent_destroy: false' 'prevent_destroy: true'


# Removing the pipeline and schema, deploy must succeed
rm resources/pipeline.yml resources/schema.yml
trace errcode $CLI bundle plan >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1
trace $CLI bundle deploy --auto-approve >>out.$DATABRICKS_BUNDLE_ENGINE.txt 2>&1
