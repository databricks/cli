#!/bin/bash

# Helper functions
check_remote_file_exists() {
    local file_path="$1"
    local remote_path="/Users/$CURRENT_USER_NAME/sync-test-special/$file_path"

    $CLI workspace get-status "$remote_path" >/dev/null 2>&1
    return $?
}

check_remote_dir_exists() {
    local dir_path="$1"
    local remote_path="/Users/$CURRENT_USER_NAME/sync-test-special/$dir_path"

    local status=$($CLI workspace get-status "$remote_path" 2>/dev/null)
    if echo "$status" | grep -q '"object_type":"DIRECTORY"'; then
        return 0
    else
        return 1
    fi
}

list_remote_dir() {
    local dir_path="$1"
    local remote_path="/Users/$CURRENT_USER_NAME/sync-test-special/$dir_path"

    $CLI workspace list "$remote_path" --output json 2>/dev/null | jq -r '.[].path' | sort
}

# Setup
mkdir -p local-sync-test-special
cd local-sync-test-special
remote_path="/Users/$CURRENT_USER_NAME/sync-test-special"

# Start sync in background
echo "Starting special characters sync..."
$CLI sync . "$remote_path" --watch --output json > sync_output.log 2>&1 &
sync_pid=$!

# Wait a bit for sync to initialize
sleep 5

# Test 1: Create directory structure with special characters
echo "Creating directory structure with special characters..."
mkdir -p "dir1/a b+c/c+d e"
echo "test content" > "dir1/a b+c/c+d e/e+f g#i.txt"
sleep 3

# Verify directories with special characters exist remotely
if check_remote_dir_exists "dir1"; then
    echo "✓ Remote directory dir1 exists"
else
    echo "✗ Remote directory dir1 does not exist"
    exit 1
fi

if check_remote_dir_exists "dir1/a b+c"; then
    echo "✓ Remote directory 'dir1/a b+c' exists"
else
    echo "✗ Remote directory 'dir1/a b+c' does not exist"
    exit 1
fi

if check_remote_dir_exists "dir1/a b+c/c+d e"; then
    echo "✓ Remote directory 'dir1/a b+c/c+d e' exists"
else
    echo "✗ Remote directory 'dir1/a b+c/c+d e' does not exist"
    exit 1
fi

# Verify file with special characters exists
if check_remote_file_exists "dir1/a b+c/c+d e/e+f g#i.txt"; then
    echo "✓ Remote file 'dir1/a b+c/c+d e/e+f g#i.txt' exists"
else
    echo "✗ Remote file 'dir1/a b+c/c+d e/e+f g#i.txt' does not exist"
    exit 1
fi

# Test 2: Test directory listings with special characters
echo "Testing directory listings with special characters..."
remote_files=$(list_remote_dir "dir1")
if echo "$remote_files" | grep -q "a b+c"; then
    echo "✓ Directory 'a b+c' found in dir1 listing"
else
    echo "✗ Directory 'a b+c' not found in dir1 listing"
    exit 1
fi

remote_files=$(list_remote_dir "dir1/a b+c")
if echo "$remote_files" | grep -q "c+d e"; then
    echo "✓ Directory 'c+d e' found in 'dir1/a b+c' listing"
else
    echo "✗ Directory 'c+d e' not found in 'dir1/a b+c' listing"
    exit 1
fi

remote_files=$(list_remote_dir "dir1/a b+c/c+d e")
if echo "$remote_files" | grep -q "e+f g#i.txt"; then
    echo "✓ File 'e+f g#i.txt' found in 'dir1/a b+c/c+d e' listing"
else
    echo "✗ File 'e+f g#i.txt' not found in 'dir1/a b+c/c+d e' listing"
    exit 1
fi

# Test 3: Test file with spaces in name
echo "Testing file with spaces in name..."
echo "file with spaces content" > "file with spaces.txt"
sleep 3

if check_remote_file_exists "file with spaces.txt"; then
    echo "✓ Remote file 'file with spaces.txt' exists"
else
    echo "✗ Remote file 'file with spaces.txt' does not exist"
    exit 1
fi

# Test 4: Test file with plus signs in name
echo "Testing file with plus signs in name..."
echo "file with plus content" > "file+with+plus.txt"
sleep 3

if check_remote_file_exists "file+with+plus.txt"; then
    echo "✓ Remote file 'file+with+plus.txt' exists"
else
    echo "✗ Remote file 'file+with+plus.txt' does not exist"
    exit 1
fi

# Test 5: Test file with hash symbols in name
echo "Testing file with hash symbols in name..."
echo "file with hash content" > "file#with#hash.txt"
sleep 3

if check_remote_file_exists "file#with#hash.txt"; then
    echo "✓ Remote file 'file#with#hash.txt' exists"
else
    echo "✗ Remote file 'file#with#hash.txt' does not exist"
    exit 1
fi

# Test 6: Delete files with special characters
echo "Deleting files with special characters..."
rm "dir1/a b+c/c+d e/e+f g#i.txt"
rm "file with spaces.txt"
rm "file+with+plus.txt"
rm "file#with#hash.txt"
sleep 3

# Verify files are deleted
if check_remote_file_exists "dir1/a b+c/c+d e/e+f g#i.txt"; then
    echo "✗ Remote file 'dir1/a b+c/c+d e/e+f g#i.txt' still exists after deletion"
    exit 1
else
    echo "✓ Remote file 'dir1/a b+c/c+d e/e+f g#i.txt' deleted successfully"
fi

if check_remote_file_exists "file with spaces.txt"; then
    echo "✗ Remote file 'file with spaces.txt' still exists after deletion"
    exit 1
else
    echo "✓ Remote file 'file with spaces.txt' deleted successfully"
fi

if check_remote_file_exists "file+with+plus.txt"; then
    echo "✗ Remote file 'file+with+plus.txt' still exists after deletion"
    exit 1
else
    echo "✓ Remote file 'file+with+plus.txt' deleted successfully"
fi

if check_remote_file_exists "file#with#hash.txt"; then
    echo "✗ Remote file 'file#with#hash.txt' still exists after deletion"
    exit 1
else
    echo "✓ Remote file 'file#with#hash.txt' deleted successfully"
fi

# Test 7: Verify empty directories with special characters are cleaned up
sleep 2

if check_remote_dir_exists "dir1/a b+c/c+d e"; then
    echo "✗ Empty directory 'dir1/a b+c/c+d e' still exists"
    exit 1
else
    echo "✓ Empty directory 'dir1/a b+c/c+d e' cleaned up"
fi

if check_remote_dir_exists "dir1/a b+c"; then
    echo "✗ Empty directory 'dir1/a b+c' still exists"
    exit 1
else
    echo "✓ Empty directory 'dir1/a b+c' cleaned up"
fi

if check_remote_dir_exists "dir1"; then
    echo "✗ Empty directory dir1 still exists"
    exit 1
else
    echo "✓ Empty directory dir1 cleaned up"
fi

# Cleanup
echo "Cleaning up..."
kill $sync_pid 2>/dev/null
cd ..
rm -rf local-sync-test-special

# Clean up remote directory
$CLI workspace delete "$remote_path" --recursive 2>/dev/null || true

echo "Special characters sync test completed successfully!"
