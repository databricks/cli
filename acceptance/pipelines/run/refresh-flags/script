title "deploy pipeline"
trace $CLI bundle deploy

print_requests() {
    jq --sort-keys 'select(.method != "GET" and (.path | contains("/pipelines")))' < out.requests.txt
    rm out.requests.txt
    read_state.py pipelines my_pipeline id name
}

title "test --refresh-all flag"
trace $PIPELINES run my_pipeline --refresh-all
trace print_requests

title "test --refresh flag with specific tables"
trace $PIPELINES run my_pipeline --refresh table1,table2
trace print_requests

title "test --full-refresh-all flag"
trace $PIPELINES run my_pipeline --full-refresh-all
trace print_requests

title "test --full-refresh flag with specific tables"
trace $PIPELINES run my_pipeline --full-refresh table1,table2
trace print_requests
