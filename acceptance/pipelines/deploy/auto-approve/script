tmpdir="./subdir"
pipelines="$tmpdir/pipelines"
mkdir -p $tmpdir

title "install pipelines cli"
trace errcode $CLI install-pipelines-cli -d $tmpdir

# First deploy to create the pipeline
trace $pipelines deploy

title "Assert the pipeline is created"
PIPELINE_ID=$($CLI bundle summary -o json | jq -r '.resources.pipelines.foo.id')
trace $CLI pipelines get "${PIPELINE_ID}" | jq "{spec}"

title "Remove resources from configuration to test auto-approve"
trace rm resources.yml

title "Try to redeploy without --auto-approve - should fail"
trace errcode $pipelines deploy

title "Redeploy with --auto-approve - should succeed"
trace $pipelines deploy --auto-approve

rm -rf $pipelines $tmpdir
