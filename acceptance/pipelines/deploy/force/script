envsubst < databricks.yml.tmpl > databricks.yml

tmpdir="./subdir"
pipelines="$tmpdir/pipelines"
mkdir -p $tmpdir

title "install pipelines cli"
trace errcode $CLI install-pipelines-cli -d $tmpdir

cleanup() {
  trace $CLI bundle destroy --auto-approve
  rm -rf $pipelines $tmpdir
}
trap cleanup EXIT

# Create git repo for branch validation
git-repo-init

# First deploy to create the pipeline
trace $pipelines deploy

title "Assert the pipeline is created"
PIPELINE_ID=$($CLI bundle summary -o json | jq -r '.resources.pipelines.foo.id')
trace $CLI pipelines get "${PIPELINE_ID}" | jq "{spec}"

title "Try to redeploy without --force - should fail due to Git branch validation"
trace errcode $pipelines deploy

title "Redeploy with --force - should succeed and bypass Git branch validation"
trace $pipelines deploy --force
